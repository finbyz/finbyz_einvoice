(()=>{var p="^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}[Z1-9ABD-J]{1}[0-9A-Z]{1}$",u="^[0-9]{2}[A-Z]{4}[0-9]{5}[A-Z]{1}[0-9]{1}[Z]{1}[0-9]{1}$",f="^[0-9]{4}[A-Z]{3}[0-9]{5}[N][R][0-9A-Z]{1}$",g="^[9][9][0-9]{2}[A-Z]{3}[0-9]{5}[O][S][0-9A-Z]{1}$",y="^[0-9]{4}[A-Z]{3}[0-9]{5}[UO]{1}[N][A-Z0-9]{1}$",w="^[0-9]{2}[A-Z]{4}[A-Z0-9]{1}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}[D][0-9A-Z]$",m=new RegExp([p,u].join("|")),b=new RegExp([f,g].join("|")),h=new RegExp(y),v=new RegExp(w),E=new RegExp([p,u,f,g,y].join("|"));frappe.provide("finbyz_einvoice");window.gst_settings=frappe.boot.gst_settings;Object.assign(finbyz_einvoice,{get_gstin_query(e,t="Company"){if(!e){frappe.show_alert({message:__("Please select {0} to get GSTIN options",[__(t)]),indicator:"yellow"});return}return{query:"finbyz_einvoice.gst_india.utils.get_gstin_list",params:{party:e,party_type:t}}},async get_gstin_options(e,t="Company"){let{query:i,params:n}=finbyz_einvoice.get_gstin_query(e,t),{message:a}=await frappe.call({method:i,args:n});return a},get_party_type(e){return in_list(frappe.boot.sales_doctypes,e)?"Customer":"Supplier"},set_state_options(e){let t=e.get_field("state");if(e.get_field("country").value!=="India"){t.set_data([]);return}t.set_data(frappe.boot.india_state_options||[])},can_enable_api(e){return e.api_secret||frappe.boot.ic_api_enabled_from_conf},is_api_enabled(e){return e||(e=gst_settings),e.enable_api&&finbyz_einvoice.can_enable_api(e)},is_e_invoice_enabled(){return finbyz_einvoice.is_api_enabled()&&gst_settings.enable_e_invoice},validate_gstin(e){if(!(!e||e.length!==15)&&(e=e.toUpperCase(),E.test(e)&&T(e)))return e},guess_gst_category(e,t){if(!e)return t&&t!=="India"?"Overseas":"Unregistered";if(v.test(e))return"Tax Deductor";if(m.test(e))return"Registered Regular";if(h.test(e))return"UIN Holders";if(b.test(e))return"Overseas"}});function T(e){let t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=t.length,n=2,a=0;for(let o=e.length-2;o>=0;o--){let _=-1;for(let d=0;d<t.length;d++)t[d]===e[o]&&(_=d);let s=n*_;n=n===2?1:2,s=Math.floor(s/i)+s%i,a+=s}let r=(i-a%i)%i;return t[r]===e[14]}window.ic=window.finbyz_einvoice;var l=class extends frappe.ui.form.QuickEntryForm{constructor(...t){super(...t);this.skip_redirect_on_error=!0,this.api_enabled=finbyz_einvoice.is_api_enabled()&&gst_settings.autofill_party_info}render_dialog(){super.render_dialog(),finbyz_einvoice.set_state_options(this.dialog)}get_address_fields(){return[{label:__("Primary Address Details"),fieldname:"primary_address_section",fieldtype:"Section Break",description:this.api_enabled?__(`When you enter a GSTIN, the permanent address linked to it is
                        autofilled by default.<br>
                        Change the Pincode to autofill other addresses.`):"",collapsible:0},{label:__("Pincode"),fieldname:"_pincode",fieldtype:"Autocomplete",ignore_validation:!0},{label:__("Address Line 1"),fieldname:"address_line1",fieldtype:"Data"},{label:__("Address Line 2"),fieldname:"address_line2",fieldtype:"Data"},{fieldtype:"Column Break"},{label:__("City"),fieldname:"city",fieldtype:"Data"},{label:__("State"),fieldname:"state",fieldtype:"Autocomplete",ignore_validation:!0},{label:__("Country"),fieldname:"country",fieldtype:"Link",options:"Country",default:frappe.defaults.get_user_default("country"),onchange:()=>{finbyz_einvoice.set_state_options(this.dialog)}},{label:__("Customer POS Id"),fieldname:"customer_pos_id",fieldtype:"Data",hidden:1}]}get_gstin_field(){return[{label:"GSTIN",fieldname:"_gstin",fieldtype:"Autocomplete",description:this.api_enabled?S():"",ignore_validation:!0,onchange:()=>{let t=this.dialog;if(this.api_enabled&&!gst_settings.sandbox_mode)return D(t);t.set_value("gst_category",finbyz_einvoice.guess_gst_category(t.doc._gstin,t.doc.country))}}]}update_doc(){let t=super.update_doc();return t.pincode=t._pincode,t.gstin=t._gstin,t}},c=class extends l{render_dialog(){this.mandatory=[...this.get_gstin_field(),...this.mandatory,...this.get_contact_fields(),...this.get_address_fields()],super.render_dialog()}get_contact_fields(){return[{label:__("Primary Contact Details"),fieldname:"primary_contact_section",fieldtype:"Section Break",collapsible:0},{label:__("Email ID"),fieldname:"_email_id",fieldtype:"Data",options:"Email"},{fieldtype:"Column Break"},{label:__("Mobile Number"),fieldname:"_mobile_no",fieldtype:"Data"}]}update_doc(){let t=super.update_doc();return t._address_line1=t.address_line1,delete t.address_line1,t.email_id=t._email_id,t.mobile_no=t._mobile_no,t}};frappe.ui.form.CustomerQuickEntryForm=c;frappe.ui.form.SupplierQuickEntryForm=c;var k=class extends l{async render_dialog(){let t=this.get_address_fields(),i=t.map(({fieldname:n})=>n);i.push("pincode","address_line1"),this.mandatory=[...this.get_dynamic_link_fields(),...this.get_gstin_field(),...this.mandatory.filter(n=>!i.includes(n.fieldname)),...t],super.render_dialog(),this.set_default_values()}get_dynamic_link_fields(){return[{fieldname:"link_doctype",fieldtype:"Link",label:"Link Document Type",options:"DocType",get_query:()=>({query:"frappe.contacts.address_and_contact.filter_dynamic_link_doctypes",filters:{fieldtype:"HTML",fieldname:"address_html"}}),onchange:async()=>{let{value:t,last_value:i}=this.dialog.get_field("link_doctype");t!==i&&await this.dialog.set_value("link_name","")}},{fieldtype:"Column Break"},{fieldname:"link_name",fieldtype:"Dynamic Link",label:"Link Name",get_options:t=>t.doc.link_doctype,onchange:async()=>{let{link_doctype:t,link_name:i}=this.dialog.doc;if(!i||!in_list(frappe.boot.gst_party_types,t))return;let{message:n}=await frappe.call("finbyz_einvoice.gst_india.utils.get_gstin_list",{party_type:t,party:i});!n||!n.length||this.dialog.fields_dict._gstin.set_data(n.join(`
`))}},{fieldtype:"Section Break"}]}update_doc(){let t=super.update_doc();if(t.link_doctype&&t.link_name){let i=frappe.model.add_child(t,"Dynamic Link","links");i.link_doctype=t.link_doctype,i.link_name=t.link_name}return t}async set_default_values(){let t=this.get_default_party();t&&t.party&&(await this.dialog.set_value("link_doctype",t.party_type),this.dialog.set_value("link_name",t.party))}get_default_party(){let t=cur_frm&&cur_frm.doc;if(t&&frappe.dynamic_link&&frappe.dynamic_link.doc===t)return{party_type:frappe.dynamic_link.doctype,party:frappe.dynamic_link.doc[frappe.dynamic_link.fieldname]}}};frappe.ui.form.AddressQuickEntryForm=k;async function D(e){let t=e.doc._gstin,i=e.get_field("_gstin");if(!t||t.length!=15){let a=e.fields_dict._pincode;a.set_data([]),a.df.onchange=null,i.set_description(S());return}let n=await C(t);R(i,n.status),x(e.doc,n),e.refresh(),O(e,n)}function R(e,t){if(!t){e.set_description("");return}let i={Active:"green",Cancelled:"red"};e.set_description(`<div class="d-flex indicator ${i[t]||"orange"}">
            Status:&nbsp;<strong>${t}</strong>
        </div>`)}function O(e,t){if(!t.all_addresses)return;let i=e.fields_dict._pincode;i.set_data(t.all_addresses.map(n=>({label:n.pincode,value:n.pincode,description:`${n.address_line1}, ${n.address_line2}, ${n.city}, ${n.state}`}))),i.df.onchange=()=>{N(e.doc,t),e.refresh()}}function C(e){return frappe.call({method:"finbyz_einvoice.gst_india.utils.gstin_info.get_gstin_info",args:{gstin:e}}).then(t=>t.message)}function x(e,t){!t||(I(e,t),t.permanent_address&&A(e,t.permanent_address))}function I(e,t){if(e.gstin=e._gstin,e.gst_category=t.gst_category,!in_list(frappe.boot.gst_party_types,e.doctype))return;let i=`${e.doctype.toLowerCase()}_name`;e[i]=t.business_name}function A(e,t){!t||(Object.assign(e,t),e._pincode=t.pincode)}function N(e,{all_addresses:t}){let{_pincode:i}=e;!i||i.length!==6||!t||A(e,t.find(n=>n.pincode==i))}function S(){return gst_settings.sandbox_mode?__("Autofill is not supported in sandbox mode"):__("Autofill party information by entering their GSTIN")}var G=["Quotation","Sales Order","Delivery Note","Sales Invoice","Purchase Order","Purchase Receipt","Purchase Invoice"];for(let e of G)Z(e),P(e);function Z(e){let t=["tax_category","company_gstin","place_of_supply"];in_list(frappe.boot.sales_doctypes,e)?t.push("customer_address","is_export_with_gst","is_reverse_charge"):t.push("supplier_address");let i=Object.fromEntries(t.map(n=>[n,a=>z(a,n)]));frappe.ui.form.on(e,i)}async function z(e,t){if(e.updating_party_details||!e.doc.company||t==="place_of_supply"&&e.__updating_gst_details)return;let i=finbyz_einvoice.get_party_type(e.doc.doctype).toLowerCase(),n=e.doc.doctype==="Quotation"?"party_name":i,a=e.doc[n];if(!a||(in_list(["company_gstin","customer_address","supplier_address"],t)&&(e.__update_place_of_supply=!0),e.__gst_update_triggered))return;e.__gst_update_triggered=!0;let r={doctype:e.doc.doctype,company:e.doc.company};await frappe.after_ajax(),e.__gst_update_triggered=!1,e.__update_place_of_supply&&(r.update_place_of_supply=1,e.__update_place_of_supply=!1);let o={};(e.doc.doctype!=="Quotation"||e.doc.party_type==="Customer")&&(o[i]=a);let _=["tax_category","gst_category","company_gstin","place_of_supply"];in_list(frappe.boot.sales_doctypes,e.doc.doctype)?_.push("customer_address","billing_address_gstin","is_export_with_gst","is_reverse_charge"):_.push("supplier_address","supplier_gstin");for(let s of _)o[s]=e.doc[s];r.party_details=JSON.stringify(o),frappe.call({method:"finbyz_einvoice.gst_india.overrides.transaction.get_gst_details",args:r,async callback(s){!s.message||(e.__updating_gst_details=!0,await e.set_value(s.message),e.__updating_gst_details=!1)}})}function P(e){frappe.ui.form.on(e,{gst_category(t){let{enable_overseas_transactions:i}=gst_settings;!["SEZ","Overseas"].includes(t.doc.gst_category)||i||frappe.throw(__("Please enable SEZ / Overseas transactions in GST Settings first"))}})}$(document).on("app_ready",async function(){if(!frappe.boot.needs_audit_trail_notification)return;await new Promise(t=>setTimeout(t,700));let e=frappe.msgprint({title:__("Configure Audit Trail"),indicator:"orange",message:__(`Dear Finbyz Einvoice User,
            <br><br>

            In accordance with
            <a
              href='https://www.mca.gov.in/Ministry/pdf/AccountsAmendmentRules_24032021.pdf'
              target='_blank'
            >MCA Notification dated 24-03-2021</a>,
            all companies registered in India are required to maintain an Audit Trail
            of each and every transaction and creating an edit log of each change made
            in books of account w.e.f 1st April 2023.
            <br><br>
            To comply with this requirement, we have introduced a new setting called
            <strong>Enable Audit Trail</strong> in Accounts Settings.
            <br><br>
            <strong>Note:</strong>
            <ul>
                <li>Once this setting is enabled, it cannot be disabled.</li>
                <li>
                Enabling this setting will cause the following accounts setting
                to get disabled to ensure Audit Trail integrity:<br>
                <strong>
                Delete Accounting and Stock Ledger Entries on deletion of Transaction
                </strong>
                </li>
            </ul>


            Would you like to enable the same?`)});e.set_primary_action(__("Enable Audit Trail"),()=>{frappe.call({method:"finbyz_einvoice.audit_trail.utils.enable_audit_trail",callback(t){t.exc||frappe.show_alert({message:__("Audit Trail Enabled"),indicator:"green"})}}),e.hide()}),e.set_secondary_action_label(__("Review Accounts Settings")),e.set_secondary_action(()=>{frappe.set_route("Form","Accounts Settings"),e.hide()}),e.onhide=()=>{frappe.xcall("finbyz_einvoice.audit_trail.utils.disable_audit_trail_notification")}});})();
//# sourceMappingURL=finbyz_einvoice.bundle.E4XW7KL2.js.map
